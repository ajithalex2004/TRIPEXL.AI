<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TripXL Booking Debug Tool</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      color: #333;
    }
    
    h1, h2, h3 {
      color: #0056b3;
    }
    
    .card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    input, select, textarea, button {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      width: 100%;
    }
    
    button {
      background: #0056b3;
      color: white;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.3s;
      width: auto;
    }
    
    button:hover {
      background: #003d82;
    }
    
    pre {
      background: #f6f8fa;
      border-radius: 4px;
      padding: 12px;
      max-height: 400px;
      overflow: auto;
      font-size: 13px;
    }
    
    .success { color: #28a745; }
    .error { color: #dc3545; }
    .warning { color: #ffc107; }
    
    .row {
      display: flex;
      gap: 20px;
    }
    
    .col {
      flex: 1;
    }
    
    @media (max-width: 768px) {
      .row {
        flex-direction: column;
      }
    }
    
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }
    
    .tab {
      padding: 10px 15px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }
    
    .tab.active {
      border-bottom-color: #0056b3;
      font-weight: 500;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <h1>TripXL Booking Diagnostic Tool</h1>
  <p>Use this tool to debug booking issues and test API endpoints</p>
  
  <div class="tabs">
    <div class="tab active" data-tab="auth">Authentication</div>
    <div class="tab" data-tab="employee">Employee Validation</div>
    <div class="tab" data-tab="payload">Payload Validation</div>
  </div>
  
  <div class="tab-content active" id="auth-tab">
    <div class="card">
      <h2>Authentication Test</h2>
      <p>Check if your authentication token is valid</p>
      
      <div class="form-group">
        <label for="auth-token">JWT Token</label>
        <input type="text" id="auth-token" placeholder="Enter your JWT token">
      </div>
      
      <button onclick="testAuth()">Test Authentication</button>
      
      <h3>Result</h3>
      <pre id="auth-result">Results will appear here...</pre>
    </div>
  </div>
  
  <div class="tab-content" id="employee-tab">
    <div class="card">
      <h2>Employee ID Validation</h2>
      <p>Check if an employee ID exists in the system</p>
      
      <div class="form-group">
        <label for="employee-id">Employee ID</label>
        <input type="text" id="employee-id" placeholder="Enter employee ID">
      </div>
      
      <button onclick="validateEmployee()">Validate Employee</button>
      
      <h3>Result</h3>
      <pre id="employee-result">Results will appear here...</pre>
    </div>
  </div>
  
  <div class="tab-content" id="payload-tab">
    <div class="card">
      <h2>Booking Payload Validation</h2>
      <p>Test if your booking payload is properly formatted</p>
      
      <div class="form-group">
        <label for="booking-payload">Booking Payload (JSON)</label>
        <textarea id="booking-payload" rows="15" placeholder="Enter booking JSON payload">
{
  "employee_id": 1001,
  "booking_type": "OFFICIAL",
  "purpose": "Hospital Visit",
  "priority": "MEDIUM",
  "pickup_location": {
    "address": "Dubai Healthcare City",
    "coordinates": {
      "lat": 25.2285,
      "lng": 55.3273
    }
  },
  "dropoff_location": {
    "address": "Rashid Hospital",
    "coordinates": {
      "lat": 25.2412,
      "lng": 55.3134
    }
  },
  "pickup_time": "2025-04-15T10:00:00Z",
  "dropoff_time": "2025-04-15T12:00:00Z"
}
</textarea>
      </div>
      
      <button onclick="validatePayload()">Validate Payload</button>
      
      <h3>Result</h3>
      <pre id="payload-result">Results will appear here...</pre>
    </div>
  </div>
  
  <script>
    // Tab functionality
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        tab.classList.add('active');
        document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
      });
    });
    
    // Format JSON output
    function formatJSON(json) {
      return JSON.stringify(json, null, 2);
    }
    
    // Authentication test
    async function testAuth() {
      const resultElement = document.getElementById('auth-result');
      const token = document.getElementById('auth-token').value.trim();
      
      if (!token) {
        resultElement.innerHTML = '<span class="error">Please enter a JWT token</span>';
        return;
      }
      
      try {
        resultElement.innerHTML = 'Testing authentication...';
        
        const response = await fetch('/api/booking-debug-trace/auth-status', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        resultElement.innerHTML = formatJSON(data);
        
        // Highlight result based on authentication status
        if (data.authenticated) {
          resultElement.innerHTML += '<div class="success">✓ Token is valid</div>';
        } else {
          resultElement.innerHTML += '<div class="error">✗ Authentication failed</div>';
        }
      } catch (error) {
        resultElement.innerHTML = `<span class="error">Error: ${error.message}</span>`;
      }
    }
    
    // Employee validation
    async function validateEmployee() {
      const resultElement = document.getElementById('employee-result');
      const employeeId = document.getElementById('employee-id').value.trim();
      
      if (!employeeId) {
        resultElement.innerHTML = '<span class="error">Please enter an employee ID</span>';
        return;
      }
      
      try {
        resultElement.innerHTML = 'Validating employee...';
        
        const response = await fetch(`/api/booking-debug-trace/validate-employee/${employeeId}`);
        const data = await response.json();
        resultElement.innerHTML = formatJSON(data);
        
        // Highlight result based on validation status
        if (data.isValid) {
          resultElement.innerHTML += `<div class="success">✓ Employee found: ${data.employee.name}</div>`;
        } else {
          resultElement.innerHTML += '<div class="error">✗ Employee not found</div>';
        }
      } catch (error) {
        resultElement.innerHTML = `<span class="error">Error: ${error.message}</span>`;
      }
    }
    
    // Payload validation
    async function validatePayload() {
      const resultElement = document.getElementById('payload-result');
      const payloadText = document.getElementById('booking-payload').value.trim();
      
      if (!payloadText) {
        resultElement.innerHTML = '<span class="error">Please enter a booking payload</span>';
        return;
      }
      
      try {
        // Parse the JSON to verify it's valid
        const payload = JSON.parse(payloadText);
        resultElement.innerHTML = 'Validating payload...';
        
        const response = await fetch('/api/booking-debug-trace/validate-payload', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        
        const data = await response.json();
        resultElement.innerHTML = formatJSON(data);
        
        // Highlight result based on validation status
        if (data.isValid) {
          resultElement.innerHTML += '<div class="success">✓ Payload is valid</div>';
        } else {
          resultElement.innerHTML += '<div class="error">✗ Payload has errors</div>';
          
          if (data.missingFields && data.missingFields.length > 0) {
            resultElement.innerHTML += `<div class="error">Missing fields: ${data.missingFields.join(', ')}</div>`;
          }
          
          if (data.locationErrors && data.locationErrors.length > 0) {
            resultElement.innerHTML += `<div class="error">Location errors: ${data.locationErrors.join(', ')}</div>`;
          }
          
          if (data.employeeIdError) {
            resultElement.innerHTML += `<div class="error">Employee ID error: ${data.employeeIdError}</div>`;
          }
        }
      } catch (error) {
        if (error instanceof SyntaxError) {
          resultElement.innerHTML = '<span class="error">Invalid JSON format. Please check your syntax.</span>';
        } else {
          resultElement.innerHTML = `<span class="error">Error: ${error.message}</span>`;
        }
      }
    }
  </script>
</body>
</html>